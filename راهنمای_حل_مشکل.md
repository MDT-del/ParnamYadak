# راهنمای حل مشکل Migration در پروژه پرنام یدک

## شرح مشکل
مشکل اصلی در ترتیب ایجاد جداول در migration است. جدول `instore_order_batch` سعی می‌کند به جدول `instore_order` ارجاع دهد، اما این جدول هنوز ایجاد نشده است.

## راه‌های حل

### روش 1: استفاده از اسکریپت نصب بهبود یافته (توصیه شده)

```bash
# در سرور لینوکس
chmod +x install.sh
./install.sh
```

این اسکریپت خودکار مشکل migration را تشخیص و حل می‌کند.

### روش 2: حل دستی مشکل

#### مرحله 1: توقف کانتینرها
```bash
docker compose down
```

#### مرحله 2: حذف volumes (اختیاری)
```bash
# فقط اگر مشکل ادامه داشت
docker volume rm parnamyadak_postgres_data
```

#### مرحله 3: حذف پوشه migrations
```bash
rm -rf migrations
```

#### مرحله 4: ساخت مجدد و اجرا
```bash
docker compose build --no-cache
docker compose up -d db

# انتظار برای آماده شدن دیتابیس
sleep 10

# حل خودکار مشکل
docker compose run --rm web python -c "
from app import create_app, db
app = create_app()
with app.app_context():
    db.create_all()
    print('✅ جداول با موفقیت ایجاد شدند!')
"

# راه‌اندازی کامل
docker compose up -d
```

### روش 3: حل مشکل با ایجاد جداول دستی

```bash
# اجرای کانتینر موقت
docker compose run --rm web python -c "
from app import create_app, db
app = create_app()
with app.app_context():
    # حذف جداول موجود
    db.drop_all()
    # ایجاد مجدد جداول
    db.create_all()
    print('✅ جداول با موفقیت ایجاد شدند!')
"
```

## بررسی وضعیت

### بررسی لاگ‌ها
```bash
docker compose logs -f web
```

### بررسی وضعیت دیتابیس
```bash
docker compose exec db psql -U parnamyadak -d parnamyadak -c "\dt"
```

### بررسی migration
```bash
docker compose run --rm web flask db current
```

## نکات مهم

1. **پشتیبان‌گیری**: قبل از هر تغییر، از دیتابیس پشتیبان بگیرید
2. **محیط تولید**: در محیط تولید، ابتدا روی محیط تست آزمایش کنید
3. **لاگ‌ها**: همیشه لاگ‌ها را بررسی کنید

## علت مشکل

مشکل اصلی در ترتیب تعریف foreign key ها در SQLAlchemy است. جدول `InStoreOrderBatch` سعی می‌کند به جدول `InStoreOrder` ارجاع دهد، اما Alembic نمی‌تواند ترتیب درست ایجاد جداول را تشخیص دهد.

## راه‌حل اعمال شده

1. **بهبود docker-entrypoint.sh**: اضافه کردن logic برای تشخیص و حل مشکل migration
2. **اسکریپت fix_migration.py**: ایجاد migration دستی با ترتیب درست جداول
3. **بهبود مدل‌ها**: اضافه کردن کامنت‌های توضیحی

## تست نهایی

بعد از حل مشکل، این دستورات را اجرا کنید:

```bash
# بررسی وضعیت کانتینرها
docker compose ps

# بررسی لاگ‌ها
docker compose logs web | tail -20

# تست دسترسی به پنل
curl -I http://localhost:5000
```

## در صورت ادامه مشکل

اگر مشکل ادامه داشت:

1. لاگ کامل را بررسی کنید: `docker compose logs`
2. فایل `.env` را بررسی کنید
3. با تیم پشتیبانی تماس بگیرید

---

**نکته**: این راهنما برای حل مشکل خاص foreign key در جدول `instore_order_batch` طراحی شده است.
