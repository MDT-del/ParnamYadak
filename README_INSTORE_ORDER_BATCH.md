# تغییرات سیستم سفارش حضوری - مدیریت دقیق موجودی FIFO

## خلاصه تغییرات

این تغییرات برای پیاده‌سازی مدیریت دقیق موجودی سفارش حضوری با استفاده از روش FIFO (First In, First Out) و پشتیبانی از مرجوعی انجام شده است.

## تغییرات اعمال شده

### 1. مدل جدید: InStoreOrderBatch
- **هدف**: واسط بین سفارش حضوری و پارت‌های انبار
- **فیلدها**:
  - `order_id`: شناسه سفارش حضوری
  - `batch_id`: شناسه پارت انبار
  - `reserved_qty`: مقدار رزرو شده
  - `sold_qty`: مقدار فروخته شده
  - `returned_qty`: مقدار مرجوع شده
  - `created_at`, `updated_at`: تاریخ‌ها

### 2. فیلدهای جدید در InventoryBatch
- `reserved_quantity`: موجودی رزرو شده در پارت
- `sold_quantity`: موجودی فروخته شده از پارت

### 3. وضعیت جدید: "مرجوع شده"
- اضافه شده به لیست `ORDER_STATUSES`

### 4. منطق جدید تغییر وضعیت

#### رزرو موجودی (آماده تحویل)
- رزرو از پارت‌ها به صورت FIFO
- ثبت در جدول `InStoreOrderBatch`
- افزایش `reserved_quantity` پارت‌ها

#### فروش (تحویل داده شده)
- انتقال از رزرو به فروش
- کاهش موجودی واقعی پارت‌ها
- افزایش آمار فروش

#### لغو رزرو (لغو شده)
- آزادسازی رزرو از پارت‌ها
- بازگشت به موجودی قابل فروش

#### مرجوعی (مرجوع شده)
- بازگرداندن موجودی فروخته شده به پارت‌ها
- اصلاح آمار فروش و درآمد

## محدودیت‌های جدید

1. **سفارش تحویل داده شده** نمی‌تواند به "آماده تحویل" برگردد
2. **سفارش تحویل داده شده** نمی‌تواند "لغو شده" شود (فقط "مرجوع شده")
3. **سفارش مرجوع شده** فقط از وضعیت "تحویل داده شده" امکان‌پذیر است

## نحوه اجرای Migration

```bash
python migration_instore_order_batch.py
```

## مزایای تغییرات

1. **دقت بالا**: هر رزرو و فروش دقیقاً روی پارت‌های مشخص ثبت می‌شود
2. **FIFO**: مدیریت موجودی بر اساس ورود اولیه
3. **مرجوعی**: امکان بازگرداندن کالا و اصلاح آمار
4. **ردیابی کامل**: تاریخچه کامل هر عملیات
5. **امنیت**: جلوگیری از تغییرات نامعتبر وضعیت

## نکات مهم

- قبل از اجرای migration، از دیتابیس backup تهیه کنید
- تغییرات فقط روی سفارش‌های "انبار مغازه" اعمال می‌شود
- سیستم پیامک برای "آماده تحویل" همچنان فعال است 