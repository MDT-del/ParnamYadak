{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block page_title %}Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø´ØªØ±ÛŒØ§Ù†{% endblock %}

{% block content %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
        <div class="p-6">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">Ù„ÛŒØ³Øª ØªÙ…Ø§Ù… Ù…Ø´ØªØ±ÛŒØ§Ù†</h2>
            <div class="mb-4 flex flex-col md:flex-row gap-2 items-center justify-between">
                <form method="get" class="flex gap-2 items-center">
                    <input type="text" name="q" value="{{ search_query or '' }}" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†..." class="w-full md:w-80 px-4 py-2 rounded border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-gray-100" />
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">Ø¬Ø³ØªØ¬Ùˆ</button>
                </form>
                <div class="flex gap-2">
                    <button onclick="updateAllCustomerTypes()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                        ğŸ”„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†ÙˆØ¹ Ù…Ø´ØªØ±ÛŒØ§Ù†
                    </button>
                    <button onclick="fixBotOrders()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                        ğŸ”§ Ø§ØµÙ„Ø§Ø­ Ø³ÙØ§Ø±Ø´Ø§Øª Ø±Ø¨Ø§Øª
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ù†Ø§Ù…</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ù†ÙˆØ¹ Ù…Ø´ØªØ±ÛŒ</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ØªØ§Ø±ÛŒØ® Ø§ÙˆÙ„ÛŒÙ† Ø³ÙØ§Ø±Ø´</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ù†ÙˆØ¹ Ø§ÙˆÙ„ÛŒÙ† Ø³ÙØ§Ø±Ø´</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø´Ù†Ø§Ø³Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {% for item in customers_with_first_order %}
                        {% set customer = item.customer %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right">
                                <div>
                                    {{ customer.full_name }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right">
                                <div class="text-xs text-gray-500 mt-1" dir="ltr">{{ customer.phone_number or '-' }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right">
                                <span class="px-2 py-1 text-xs rounded-full 
                                    {% if customer.customer_type == 'Ù…Ú©Ø§Ù†ÛŒÚ©' %}bg-blue-100 text-blue-800{% endif %}
                                    {% if customer.customer_type == 'Ø±Ø¨Ø§Øª' %}bg-green-100 text-green-800{% endif %}
                                    {% if customer.customer_type == 'Ø­Ø¶ÙˆØ±ÛŒ' %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ customer.customer_type or 'Ø­Ø¶ÙˆØ±ÛŒ' }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right">
                                {% if customer.first_order_date %}{{ customer.first_order_date|to_shamsi('%Y/%m/%d - %H:%M') }}{% else %}-{% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right">
                                {{ customer.first_order_type or '-' }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100 text-right">{{ customer.telegram_id or '-' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right">{% if customer.username %}@{{ customer.username }}{% else %}-{% endif %}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right">
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <!-- Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
                                    <a href="{{ url_for('customers.view_customer', customer_id=customer.id) }}"
                                       class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 transition-colors"
                                       title="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„">
                                        <i class="bi bi-eye text-lg"></i>
                                    </a>

                                    <!-- ÙˆÛŒØ±Ø§ÛŒØ´ -->
                                    <a href="{{ url_for('customers.edit_customer', customer_id=customer.id) }}"
                                       class="text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300 transition-colors"
                                       title="ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª">
                                        <i class="bi bi-pencil-square text-lg"></i>
                                    </a>

                                    <!-- Ø­Ø°Ù -->
                                    <button onclick="deleteCustomer({{ customer.id }}, '{{ customer.full_name }}')"
                                            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 transition-colors"
                                            title="Ø­Ø°Ù Ù…Ø´ØªØ±ÛŒ">
                                        <i class="bi bi-trash text-lg"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center px-6 py-8 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                <div class="flex flex-col items-center">
                                    <i class="bi bi-people text-4xl text-gray-300 dark:text-gray-600 mb-2"></i>
                                    <p>Ù‡ÛŒÚ† Ù…Ø´ØªØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- pagination -->
            <div class="flex justify-center mt-4">
                {% if customers.has_prev %}
                    <a href="?q={{ search_query }}&page={{ customers.prev_num }}" class="px-3 py-1 mx-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">Ù‚Ø¨Ù„ÛŒ</a>
                {% endif %}
                <span class="px-3 py-1 mx-1">ØµÙØ­Ù‡ {{ customers.page }} Ø§Ø² {{ customers.pages }}</span>
                {% if customers.has_next %}
                    <a href="?q={{ search_query }}&page={{ customers.next_num }}" class="px-3 py-1 mx-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">Ø¨Ø¹Ø¯ÛŒ</a>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
function deleteCustomer(customerId, customerName) {
    // Ù†Ù…Ø§ÛŒØ´ ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù
    if (confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù…Ø´ØªØ±ÛŒ "${customerName}" Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ\n\nØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª Ùˆ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø§ÛŒÙ† Ù…Ø´ØªØ±ÛŒ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.`)) {
        // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø­Ø°Ù
        fetch(`{{ url_for('customers.delete_customer', customer_id=0) }}`.replace('0', customerId), {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
                showToast('Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯', 'success');
                // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² 1 Ø«Ø§Ù†ÛŒÙ‡
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§
                showToast(data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù…Ø´ØªØ±ÛŒ', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        });
    }
}

function showToast(message, type = 'info') {
    // Ø§ÛŒØ¬Ø§Ø¯ toast notification
    const toast = document.createElement('div');
    toast.className = `fixed top-4 left-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-all duration-300 transform translate-x-full`;

    // ØªÙ†Ø¸ÛŒÙ… Ø±Ù†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹
    if (type === 'success') {
        toast.className += ' bg-green-500';
    } else if (type === 'error') {
        toast.className += ' bg-red-500';
    } else {
        toast.className += ' bg-blue-500';
    }

    toast.textContent = message;
    document.body.appendChild(toast);

    // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ÙˆØ±ÙˆØ¯
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);

    // Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

function updateAllCustomerTypes() {
    if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†ÙˆØ¹ Ù‡Ù…Ù‡ Ù…Ø´ØªØ±ÛŒØ§Ù† Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯.')) {
        return;
    }

    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...';
    button.disabled = true;

    fetch('/customers/api/update-all-types', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`âœ… ${data.updated_count} Ù…Ø´ØªØ±ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯`, 'success');
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² 2 Ø«Ø§Ù†ÛŒÙ‡
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showToast(`âŒ Ø®Ø·Ø§: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function fixBotOrders() {
    if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø§ØµÙ„Ø§Ø­ Ø§Ø±ØªØ¨Ø§Ø· Ø³ÙØ§Ø±Ø´Ø§Øª Ø±Ø¨Ø§Øª Ø¨Ø§ Ù…Ø´ØªØ±ÛŒØ§Ù† Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
        return;
    }

    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§ØµÙ„Ø§Ø­...';
    button.disabled = true;

    fetch('/customers/api/fix-bot-orders', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`âœ… ${data.fixed_count} Ø³ÙØ§Ø±Ø´ Ø±Ø¨Ø§Øª Ø§ØµÙ„Ø§Ø­ Ø´Ø¯`, 'success');
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² 2 Ø«Ø§Ù†ÛŒÙ‡
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showToast(`âŒ Ø®Ø·Ø§: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØµÙ„Ø§Ø­ Ø³ÙØ§Ø±Ø´Ø§Øª', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
</script>
{% endblock %}